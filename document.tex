%------------------------------------------------------------------------------
% Template file for the submission of papers to IUCr journals in LaTeX2e
% using the iucr document class
% Copyright 1999-2003 International Union of Crystallography
% Version 1.2 (11 December 2002)
%------------------------------------------------------------------------------

\documentclass{iucr}              % DO NOT DELETE THIS LINE

                   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                   \def\href#1{\relax}\let\foo\caption
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% To generate hyperlinked PDF, change the \documentclass line
% to say \documentclass[pdf]{iucr} and process with pdflatex
\ifPDF
  \RequirePackage{hyperref}
  \PassOptionsToPackage{pdftex,bookmarksopen,bookmarksnumbered}{hyperref}
  \voffset=-0.5in
\fi
\let\caption\foo
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%------------------------------------------------------------------------------
% Information about the type of paper
%------------------------------------------------------------------------------
     \paperprodcode{a000000}      % Replace with production code if known
     \paperref{xx9999}            % Replace xx9999 with reference code if known
     \papertype{IU}               % Indicate type of article
                                  %   FA - research papers (full article)
                                  %   SC - short communications
                                  %   FC - fast communications
                                  %   LA - lead article
                                  %   TR - topical review
                                  %   XL - crystallization papers
                                  % (Following categories rarely in LaTeX)
                                  %   AA - abstracts
                                  %   AD - addenda and errata
                                  %   AI - inorganic compounds
                                  %   AM - metal-organic compounds
                                  %   AO - organic compounds
                                  %   BC - books received
                                  %   BR - book reviews
                                  %   BI - biography
                                  %   CA - cif applications
                                  %   CD - crystal data
                                  %   CE - current events
                                  %   CI - inorganic compounds
                                  %   CL - calendar of events
                                  %   CM - metal-organic compounds
                                  %   CN - cryocrystallography papers
                                  %   CO - organic compounds
                                  %   CP - computer programs
                                  %   CR - crystallographers
                                  %   CS - scientific comment
                                  %   ED - editorial
                                  %   EI - inorganic compounds
                                  %   EM - metal-organic compounds
                                  %   EO - organic compounds
                                  %   FI - inorganic compounds
                                  %   FM - metal-organic compounds
                                  %   FO - organic compounds
                                  %   IP - issue preface
                                  %   IU - iucr
                                  %   LE - letters to the editor
                                  %   LN - laboratory notes
                                  %   ME - forthcoming meetings/short courses
                                  %   MR - meeting reports
                                  %   NN - notes and news
                                  %   NP - new commercial products
                                  %   OB - obituaries
                                  %   PA - computer program abstracts
                                  %   RI - reference information
                                  %   SG - structural genomics papers
                                  %   SI - short format inorganic compounds
                                  %   SM - short format metal-organic compounds
                                  %   SO - short format organic compounds
                                  %   SP - short structural papers
                                  %   SR - software reviews
                                  %   TE - teaching and education

     \paperlang{english}          % Can be english, french, german or russian
%------------------------------------------------------------------------------
% Information about journal to which submitted
%------------------------------------------------------------------------------
     %\journalcode{A}             % Indicate the journal to which submitted
                                  %   A - Acta Crystallographica Section A
                                  %   B - Acta Crystallographica Section B
                                  %   C - Acta Crystallographica Section C
                                  %   D - Acta Crystallographica Section D
                                  %   J - Journal of Applied Crystallography
                                  %   S - Journal of Synchrotron Radiation
     %-------------------------------------------------------------------------
     % The following entries will be changed as required by editorial staff
     %-------------------------------------------------------------------------
     \journalyr{2017}
     %\journaliss{1}
     %\journalvol{57}
     %\journalfirstpage{1}
     %\journallastpage{11}
     \journalreceived{\relax}
     \journalaccepted{\relax}
     \journalonline{\relax}

\begin{document}                  % DO NOT DELETE THIS LINE

     %-------------------------------------------------------------------------
     % The introductory (header) part of the paper
     %-------------------------------------------------------------------------

     % The title of the paper. Use \shorttitle to indicate an abbreviated title
     % for use in running heads (you will need to uncomment it).

\title{Calibration of the experimetal setup in pyFAI with a goniometer
mounted detector}
\shorttitle{Using pyFAI with a goniometer}

     % Authors' names and addresses. Use \cauthor for the main (contact) author.
     % Use \author for all other authors. Use \aff for authors' affiliations.
     % Use lower-case letters in square brackets to link authors to their
     % affiliations; if there is only one affiliation address, remove the [a].

     \cauthor[a]{J.}{Kieffer}{jerome.kieffer@esrf.eu}
     \author[a]{J.}{Kieffer}
     \author[a]{V.}{Valls}
     
     %\aufn{On leave from Institute
     %of Advanced Research, Albany, Ruritania.}

     \aff[a]{ESRF \city{Grenoble}, \country{France}}
     %\aff[b]{3 Watery Way, \city{Full Fathom} 5, \country{Atlantis}}

     % Use \shortauthor to indicate an abbreviated author list for use in
     % running heads (you will need to uncomment it).

\shortauthor{Kieffer et al.}

     % Use \vita if required to give biographical details (for authors of
     % invited review papers only). Uncomment it.


%\vita{Joe Soape is an archetypal generic author, whose association with the
%much-travelled Kilroy has extended over many years. He travels to work each
%day on a Clapham omnibus.
%\\
%John Doe is also a generic individual with extensive experience of legal and
%forensic matters.}

     % Keywords (required for Journal of Synchrotron Radiation only)
     % Use the \keyword macro for each word or phrase, e.g.
     % \keyword{X-ray diffraction}\keyword{muscle}

\keyword{\LaTeX}
\keyword{class file}
\keyword{documentation}

     % PDB and NDB reference codes for structures referenced in the article and
     % deposited with the Protein Data Bank and Nucleic Acids Database (Acta
     % Crystallographica Section D). Repeat for each separate structuree.g.
     % \PDBref[dethiobiotin synthetase]{1byi} \NDBref[d(G$_4$CGC$_4$)]{ad0002}

%\PDBreference[optional name]{refcode}
%\NDBreference[optional name]{refcode}

\maketitle                        % DO NOT DELETE THIS LINE

\begin{synopsis}
Explain how to obtain a powder diffraction pattern from
many images images taken with a 2D X-Ray detector mounted on a moving arm
(goniometer) and how to define precisely the position of the detector on the
moving arm from Debye-Scherrer ring of a reference compound.
\end{synopsis}

\begin{abstract}
TODO
\end{abstract}


     %-------------------------------------------------------------------------
     % The main body of the paper
     %-------------------------------------------------------------------------
     % Now enter the text of the document in multiple \section's, \subsection's
     % and \subsubsection's as required.


\section{Introduction}

Area detectors mounted on goniometer arms are commonly available for
powder-diffraction data acquisition in lab-source diffractometer (for example
Rigaku HyPix-3000).
%The larger number of pixels trades-of the resolution for speed.
On the oposite, moving detector setups are rarely used at synchrotrons for
the data acquisition itself, even if most of the detectors are mounted on a
moving table.
So at large facilities like synchrotons, larger detectors are 
prefered and kept fix during the whole acquisition, often to ease the
data-reduction step.
The fixed position setup combined with the speed of modern detectors allows
easily the acquisition in kinetic mode for following chemical reaction or other
physical processes.

Nevertheless high-Q acquisition is needed for Pair-wise Distribution Function
(PDF) analysis which requires even larger detectors and higher energies to be
able to cover the Q-range with one single frame.
When speed is not a critical parameter, such experiment could be done with a
smaller detector mounted on a moving arm which is moved during the
acquisition; this setup being already available on most diffraction beamlines.

This document presents first shortly the pyFAI library\cite{} then how to merge
multiple diffraction images acquired at different positions with this
library\cite{}. 
Then it explains how to calibrate the absolute position of every single
pixel in the detector when mounted on a goniometer (or of the translation table)
as function of the parameter of the goniometer. 

\section{The fast azimuthal integration library}

PyFAI is a Python library used to tranform 2D diffraction images into 1D powder
diffraction pattern using rebinning of the pixel position to polar coordinates.
It provides in addition tools to calibrate the detector position, i.e. determine
where it is located in space from the conics drawn by the Debye-Scherrer cones
intersected by the detector (ellipses when the detector is planar and slightly
inclined). This document describes the processing implemented in pyFAI
v0.14 which is to be published in 2017/still under development.

Azimuthal integration is performed in two steps, the first is a pixel-wise
transformation corresponding the image correction:
$$
I_{cor} = \frac{signal}{normalization}  = \frac{I_{raw} - I_{dark}}{F \times
\Omega \times P \times A } $$
where $I_{raw}$ is the raw detector signal, $I_{dark}$ is the dark current
image (may be also the background image for certain experiments), $F$ referes to
the flat-field correction, $\Omega$ to the solid angle of the given pixel, $P$
referes to polarization correction and $A$ referes to detector efficiency due
to in volume absorption due to parallax effects.

For azimuthal integration the numerator of this formula, herafter refered as
\textit{signal}, is separeted from the denominator which is refered as
\textit{normalization}.

The rebinning of the data is performed using an histogram of the position ($q$
or $2\theta$ values) weighted by the \textit{signal}.
This gives the sum of all signals withing a ring.
A second histogram of the positions is calculated, weighted by the
\textit{normalization} this time, which gives the sum of all normalizations
values.

The average signal over a ring is then simply the ratio of the two histograms.

$$
<I>_{ring} = \frac{\sum\limits_{i _in ring} c_i \times signal_i}
                  {\sum\limits_{i _in ring} c_i \times normalization_i} 
$$


In pyFAI the use can chose among multiple pixel splitting schemes, the histogram
corresponds actually to no splitting at all; histogram being also the easiest
algorithm to implement and understand. 
Those multiple pixel splitting schemes have already been described in \cite{}
and can be accelerate using look-up tables \cite{}.

\section{Azimuthal integration of multiple frames taken at multiple geometries}

The integration of multiple images taken at varying position has first been
reported for pyFAI in \cite{PyFAI_PDJ}. 
The procedure is conceptually similar to the integration    


\section{Calibration using a Debye-Scherrer diffraction image}


\section{Calibration of a goniometer}



\end{document}
